<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Gerador de Links (v7.2 - HTA com IA)</title>
    
    <HTA:APPLICATION ID="GeradorZap" APPLICATIONNAME="GeradorFinalIA" SCROLL="yes" SINGLEINSTANCE="yes" WINDOWSTATE="normal" />

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 500px; width: 100%; }
        h1, h2 { color: #1c1e21; text-align: center; margin-top: 0; margin-bottom: 20px; }
        h1 { font-size: 24px; }
        h2 { font-size: 16px; font-weight: 600; color: #4b4f56; border-top: 1px solid #eee; padding-top: 20px; margin-top: 25px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; color: #4b4f56; font-weight: 600; font-size: 14px; }
        input, textarea, select { width: 95%; padding: 10px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 15px; }
        textarea { resize: vertical; min-height: 80px; }
        .button-group { display: flex; gap: 10px; margin-top: 12px; }
        button { flex-grow: 1; padding: 12px; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; color: #ffffff; transition: background-color 0.2s; }
        .primary { background-color: #25D366; }
        .tertiary { background-color: #6c757d; }
        .save-contact { background-color: #0d6efd; }
        .edit-contact { background-color: #ffc107; color: #000; }
        .danger { background-color: #dc3545; }
        .ai-button { background-color: #6f42c1; font-size: 12px; padding: 8px; flex-grow: 0; margin-top: -5px; }
        .hidden { display: none; }
        #statusBar { margin-top: 20px; padding: 10px; text-align: center; border-radius: 6px; font-weight: bold; color: white; opacity: 0; transition: opacity 0.5s; }
        #statusBar.success { background-color: #28a745; }
        #statusBar.error { background-color: #dc3545; }
        #statusBar.visible { opacity: 1; }
        #historicoContainer { background-color: #f8f9fa; border: 1px solid #dddfe2; border-radius: 6px; padding: 10px; min-height: 80px; max-height: 150px; overflow-y: auto; font-size: 12px; line-height: 1.5; margin-top: 15px; }
        .historicoItem { padding-bottom: 5px; margin-bottom: 5px; border-bottom: 1px dotted #ccc; cursor: pointer; }
        .historicoItem:hover { background-color: #e9ecef; }
        .historicoItem:last-child { border-bottom: none; }
        #corrigindoStatus { font-size: 12px; color: #6c757d; text-align: right; height: 15px;}
    </style>
</head>

<body onload="inicializar()">

    <div class="container">
        <h1>Gerador de Links</h1>
        
        <h2>Agenda de Alunos</h2>
        <div class="input-group"> <label for="filtroAgenda">Buscar na Agenda:</label> <input type="text" id="filtroAgenda" placeholder="Digite para filtrar..." onkeyup="renderizarAgenda()"> </div>
        <div class="input-group"> <label for="agenda">Alunos Salvos:</label> <select id="agenda" size="4" onchange="carregarContato()"> <option>-- Agenda Vazia --</option> </select> </div>
        <div class="button-group" style="margin-top:-5px; margin-bottom: 20px;">
            <button class="edit-contact" onclick="entrarModoEdicao()">Editar Aluno</button>
            <button class="danger" onclick="deletarContato()">Deletar Aluno</button>
        </div>
        
        <h2>Informações do Contato</h2>
        <div class="input-group"> <label>Celular:</label> <input type="text" id="celular" value="5511" oninput="this.value=this.value.replace(/\D/g,'')"> </div>
        <div class="input-group"> <label>Nome do Aluno(a):</label> <input type="text" id="aluno"> </div>
        <div class="input-group"> <label>Série/Turma:</label> <input type="text" id="serie"> </div>
        <div class="button-group">
            <button id="btnSalvarNovo" class="save-contact" onclick="salvarContato()">Salvar Novo Contato</button>
            <button id="btnSalvarEdicao" class="edit-contact hidden" onclick="salvarEdicao()">Salvar Alterações</button>
        </div>
        
        <h2>Mensagem</h2>
        <div class="input-group">
            <label>Texto da Mensagem:</label>
            <textarea id="mensagem" placeholder="Digite sua mensagem aqui..."></textarea>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button class="ai-button" onclick="corrigirTextoComIA()">Corrigir Texto com IA</button>
                <div id="corrigindoStatus"></div>
            </div>
        </div>
        <div class="button-group">
            <button class="primary" onclick="executarEnvio()">Gerar e Abrir WhatsApp</button>
            <button class="tertiary" onclick="limparTudo()">Limpar Campos</button>
        </div>
        
        <h2>Últimos Envios</h2>
        <div id="historicoContainer"></div>
        <div id="statusBar"></div>
    </div>

    <script>
        // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
        var SUA_CHAVE_API_AQUI = "AIzaSyB_8nHLA03AodaxHYxZJgpEVLPo5s1EiJc";

        var fso = new ActiveXObject("Scripting.FileSystemObject");
        var nomeArquivoAgenda = "agenda_alunos.json";
        var nomeArquivoHistorico = "historico_gerador.txt";
        var todosOsContatos = [];
        var contatoOriginalParaEditar = null;

        // --- INICIALIZAÇÃO ---
        function inicializar() {
            carregarAgenda();
            carregarHistorico();
        }

        // --- FUNÇÕES DA INTERFACE E STATUS ---
        function mostrarStatus(mensagem, tipo) {
            var statusBar = document.getElementById('statusBar');
            statusBar.textContent = mensagem;
            statusBar.className = tipo;
            statusBar.classList.add('visible');
            setTimeout(function() { statusBar.classList.remove('visible'); }, 4000);
        }

        // --- FUNÇÕES DA AGENDA (USANDO ARQUIVO JSON) ---
        function carregarAgenda() {
            todosOsContatos = [];
            if (fso.FileExists(nomeArquivoAgenda)) {
                var file = fso.OpenTextFile(nomeArquivoAgenda, 1);
                var conteudoJson = "";
                if (!file.AtEndOfStream) { conteudoJson = file.ReadAll(); }
                file.Close();
                if (conteudoJson) { try { todosOsContatos = JSON.parse(conteudoJson); } catch(e) {} }
            }
            renderizarAgenda();
        }

        function renderizarAgenda() {
            var filtro = document.getElementById('filtroAgenda').value.toLowerCase();
            var selectAgenda = document.getElementById('agenda');
            selectAgenda.innerHTML = '';
            
            var contatosFiltrados = [];
            for (var i = 0; i < todosOsContatos.length; i++) {
                var contato = todosOsContatos[i];
                if (contato.nome.toLowerCase().indexOf(filtro) !== -1 || contato.serie.toLowerCase().indexOf(filtro) !== -1) {
                    contatosFiltrados.push(contato);
                }
            }

            if (contatosFiltrados.length === 0) {
                selectAgenda.innerHTML = '<option value="">-- Nenhum resultado --</option>';
                return;
            }

            for (var j = 0; j < contatosFiltrados.length; j++) {
                var option = document.createElement('option');
                option.value = JSON.stringify(contatosFiltrados[j]);
                option.textContent = contatosFiltrados[j].nome + " (" + contatosFiltrados[j].serie + ")";
                selectAgenda.appendChild(option);
            }
        }

        function salvarAgendaNoArquivo() {
            var conteudoJson = JSON.stringify(todosOsContatos, null, 2);
            var file = fso.OpenTextFile(nomeArquivoAgenda, 2, true);
            file.Write(conteudoJson);
            file.Close();
        }

        function salvarContato() {
            var nome = document.getElementById('aluno').value.trim();
            var serie = document.getElementById('serie').value.trim();
            var celular = document.getElementById('celular').value.trim();
            if (!nome || !serie || !celular) { mostrarStatus("Preencha Nome, Série e Celular para salvar.", "error"); return; }
            
            var existe = false;
            for(var i = 0; i < todosOsContatos.length; i++) {
                if (todosOsContatos[i].celular === celular) {
                    existe = true;
                    break;
                }
            }
            if (existe) { mostrarStatus("Este número de celular já existe na agenda.", "error"); return; }

            todosOsContatos.push({ nome: nome, serie: serie, celular: celular });
            salvarAgendaNoArquivo();
            mostrarStatus("Aluno '" + nome + "' salvo com sucesso!", "success");
            carregarAgenda();
            limparTudo();
        }
        
        function carregarContato() {
            var selectAgenda = document.getElementById('agenda');
            if (!selectAgenda.value) return;
            try {
                var contato = JSON.parse(selectAgenda.value);
                document.getElementById('aluno').value = contato.nome;
                document.getElementById('serie').value = contato.serie;
                document.getElementById('celular').value = contato.celular;
            } catch (e) {}
        }

        function entrarModoEdicao() {
            var selectAgenda = document.getElementById('agenda');
            if (!selectAgenda.value) { mostrarStatus("Selecione um aluno da lista para editar.", "error"); return; }
            try {
                contatoOriginalParaEditar = JSON.parse(selectAgenda.value);
                carregarContato();
                document.getElementById('btnSalvarNovo').classList.add('hidden');
                document.getElementById('btnSalvarEdicao').classList.remove('hidden');
                mostrarStatus("Modo de Edição: Altere os dados e clique em 'Salvar Alterações'.", "success");
            } catch (e) { mostrarStatus("Selecione um aluno válido para editar.", "error"); }
        }

        function salvarEdicao() {
            var nomeEditado = document.getElementById('aluno').value.trim();
            var serieEditada = document.getElementById('serie').value.trim();
            var celularEditado = document.getElementById('celular').value.trim();
            if (!nomeEditado || !serieEditada || !celularEditado) { mostrarStatus("Todos os campos devem estar preenchidos.", "error"); return; }

            var index = -1;
            for (var i = 0; i < todosOsContatos.length; i++) {
                if (todosOsContatos[i].celular === contatoOriginalParaEditar.celular) { index = i; break; }
            }

            if (index !== -1) {
                todosOsContatos[index] = { nome: nomeEditado, serie: serieEditada, celular: celularEditado };
                salvarAgendaNoArquivo();
                mostrarStatus("Contato atualizado com sucesso!", "success");
            } else { mostrarStatus("Erro: Contato original não encontrado.", "error"); }
            sairModoEdicao();
        }
        
        function sairModoEdicao() {
            contatoOriginalParaEditar = null;
            document.getElementById('btnSalvarNovo').classList.remove('hidden');
            document.getElementById('btnSalvarEdicao').classList.add('hidden');
            limparTudo();
            carregarAgenda();
        }

        function deletarContato() {
            var selectAgenda = document.getElementById('agenda');
            if (!selectAgenda.value) { mostrarStatus("Selecione um aluno para deletar.", "error"); return; }
            try {
                var contatoParaDeletar = JSON.parse(selectAgenda.value);
                if (confirm("Remover '" + contatoParaDeletar.nome + "' da agenda?")) {
                    var novaLista = [];
                    for(var i = 0; i < todosOsContatos.length; i++) {
                        if (todosOsContatos[i].celular !== contatoParaDeletar.celular) {
                            novaLista.push(todosOsContatos[i]);
                        }
                    }
                    todosOsContatos = novaLista;
                    salvarAgendaNoArquivo();
                    mostrarStatus("Aluno removido com sucesso.", "success");
                    limparTudo();
                    carregarAgenda();
                }
            } catch (e) { mostrarStatus("Selecione um aluno válido para deletar.", "error"); }
        }

        function limparTudo() {
            document.getElementById('celular').value = '5511';
            document.getElementById('aluno').value = '';
            document.getElementById('serie').value = '';
            document.getElementById('mensagem').value = '';
            document.getElementById('agenda').selectedIndex = -1;
            document.getElementById('filtroAgenda').value = '';
            if (contatoOriginalParaEditar) { sairModoEdicao(); }
            renderizarAgenda();
        }
        
        // --- FUNÇÕES DE HISTÓRICO ---
        function carregarHistorico() {
            var container = document.getElementById('historicoContainer');
            if (!container) return;
            container.innerHTML = '';
            if (fso.FileExists(nomeArquivoHistorico)) {
                var file = fso.OpenTextFile(nomeArquivoHistorico, 1);
                var content = [];
                while (!file.AtEndOfStream) { content.push(file.ReadLine()); }
                file.Close();
                var ultimosEnvios = content.slice(-20).reverse();
                for(var i = 0; i < ultimosEnvios.length; i++) {
                    var linha = ultimosEnvios[i];
                    if (linha.trim() === "") continue;
                    var itemDiv = document.createElement('div');
                    itemDiv.className = 'historicoItem';
                    itemDiv.textContent = linha;
                    var separador = "Mensagem: ";
                    var pos = linha.indexOf(separador);
                    if (pos !== -1) {
                        var mensagem = linha.substring(pos + separador.length);
                        itemDiv.setAttribute('data-mensagem', mensagem);
                    }
                    itemDiv.ondblclick = function() { reusarMensagem(this); };
                    container.appendChild(itemDiv);
                }
            }
        }
        
        function reusarMensagem(elemento) {
            var mensagem = elemento.getAttribute('data-mensagem');
            if (mensagem) {
                document.getElementById('mensagem').value = mensagem;
                mostrarStatus("Mensagem copiada do histórico!", "success");
            }
        }

        // --- FUNÇÃO DE IA ---
        function corrigirTextoComIA() {
            var textInput = document.getElementById('mensagem');
            var statusDiv = document.getElementById('corrigindoStatus');
            var textoOriginal = textInput.value;

            if (!textoOriginal) { mostrarStatus("Digite uma mensagem para corrigir.", "error"); return; }
            if (!SUA_CHAVE_API_AQUI || SUA_CHAVE_API_AQUI === "COLE_A_SUA_CHAVE_AQUI") {
                 mostrarStatus("Chave API não configurada no código-fonte.", "error");
                return;
            }

            statusDiv.textContent = "Corrigindo...";
            
            var prompt = 'Corrija a gramática, ortografia e concordância do seguinte texto em português, mantendo o tom original. Retorne apenas o texto corrigido, sem nenhuma outra palavra, explicação ou formatação:\n\n"' + textoOriginal + '"';

            var http = new ActiveXObject("MSXML2.XMLHTTP");
            var url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=" + SUA_CHAVE_API_AQUI;
            var body = JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] });

            http.open("POST", url, true);
            http.setRequestHeader("Content-Type", "application/json");
            http.onreadystatechange = function() {
                if (http.readyState === 4) {
                    statusDiv.textContent = "";
                    if (http.status === 200) {
                        var response = JSON.parse(http.responseText);
                        var textoCorrigido = response.candidates[0].content.parts[0].text.trim();
                        textInput.value = textoCorrigido;
                        mostrarStatus("Texto corrigido pela IA!", "success");
                    } else {
                        mostrarStatus("Erro ao conectar com a IA. Verifique a chave ou a conexão.", "error");
                        console.log("Erro da API: " + http.responseText);
                    }
                }
            }
            http.send(body);
        }

        // --- FUNÇÃO DE ENVIO ---
        function executarEnvio() {
            var aluno = document.getElementById('aluno').value.trim();
            var celular = document.getElementById('celular').value.trim();
            var mensagem = document.getElementById('mensagem').value.trim();
            var serie = document.getElementById('serie').value.trim();
            if (!aluno || !serie || !celular || celular.length < 12 || !mensagem) {
                mostrarStatus("Preencha todos os campos antes de gerar o link.", "error");
                return;
            }

            try {
                var agora = new Date();
                var timestampSeguro = agora.getFullYear() + '-' + (agora.getMonth() + 1) + '-' + agora.getDate() + ' ' + agora.getHours() + ':' + agora.getMinutes() + ':' + agora.getSeconds();
                var mensagemParaSalvar = mensagem.replace(/\n/g, " ");
                var file = fso.OpenTextFile(nomeArquivoHistorico, 8, true);
                var linhaHistorico = timestampSeguro + " - Para: " + aluno + " - " + serie + " (" + celular + ") Mensagem: " + mensagemParaSalvar;
                file.WriteLine(linhaHistorico);
                file.WriteLine(""); 
                file.Close();
            } catch (e) {
                mostrarStatus("Falha ao salvar no histórico.", "error");
            }
            setTimeout(function() {
                gerarLink();
                carregarHistorico();
            }, 200);
        }

        function gerarLink() {
            var celular = document.getElementById('celular').value;
            var mensagem = document.getElementById('mensagem').value;
            var aluno = document.getElementById('aluno').value;
            var serie = document.getElementById('serie').value;
            
            var nomeEscola = "E.E. Prof. Neiva de Lourdes Andrade";
            var mensagemFinal = nomeEscola + "\n\n" + aluno + " - " + serie + "\n\n" + mensagem;

            var textoCodificado = encodeURIComponent(mensagemFinal);
            var urlWhatsApp = "https://wa.me/" + celular + "?text=" + textoCodificado;
            
            try {
                new ActiveXObject("WScript.Shell").run(urlWhatsApp);
                limparTudo();
            } catch (e) {
                mostrarStatus("Não foi possível abrir o link.", "error");
            }
        }
    </script>
</body>
</html>