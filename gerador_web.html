<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Links (v7.1 - Web com IA)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 500px; width: 100%; }
        h1, h2 { color: #1c1e21; text-align: center; margin-top: 0; margin-bottom: 20px; }
        h1 { font-size: 24px; }
        h2 { font-size: 16px; font-weight: 600; color: #4b4f56; border-top: 1px solid #eee; padding-top: 20px; margin-top: 25px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; color: #4b4f56; font-weight: 600; font-size: 14px; }
        input, textarea, select { width: 95%; padding: 10px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 15px; }
        textarea { resize: vertical; min-height: 80px; }
        .button-group { display: flex; gap: 10px; margin-top: 12px; }
        button { flex-grow: 1; padding: 12px; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; color: #ffffff; transition: background-color 0.2s; }
        .primary { background-color: #25D366; } .primary:hover { background-color: #128C7E; }
        .tertiary { background-color: #6c757d; } .tertiary:hover { background-color: #5a6268; }
        .save-contact { background-color: #0d6efd; } .save-contact:hover { background-color: #0b5ed7; }
        .edit-contact { background-color: #ffc107; color: #000; } .edit-contact:hover { background-color: #ffca2c; }
        .danger { background-color: #dc3545; } .danger:hover { background-color: #c82333; }
        .ai-button { background-color: #6f42c1; font-size: 12px; padding: 8px; flex-grow: 0; margin-top: -5px; } .ai-button:hover { background-color: #5a349b; }
        .hidden { display: none; }
        #statusBar { margin-top: 20px; padding: 10px; text-align: center; border-radius: 6px; font-weight: bold; color: white; opacity: 0; transition: opacity 0.5s; }
        #statusBar.success { background-color: #28a745; }
        #statusBar.error { background-color: #dc3545; }
        #statusBar.visible { opacity: 1; }
        #historicoContainer { background-color: #f8f9fa; border: 1px solid #dddfe2; border-radius: 6px; padding: 10px; min-height: 80px; max-height: 150px; overflow-y: auto; font-size: 12px; line-height: 1.5; margin-top: 15px; }
        .historicoItem { padding-bottom: 5px; margin-bottom: 5px; border-bottom: 1px dotted #ccc; cursor: pointer; }
        .historicoItem:hover { background-color: #e9ecef; }
        .historicoItem:last-child { border-bottom: none; }
        #corrigindoStatus { font-size: 12px; color: #6c757d; text-align: right; height: 15px;}
    </style>
</head>

<body>

    <div class="container">
        <h1>Gerador de Links</h1>
        
        <h2>Agenda de Alunos</h2>
        <div class="input-group"> <label for="filtroAgenda">Buscar na Agenda:</label> <input type="text" id="filtroAgenda" placeholder="Digite para filtrar..."> </div>
        <div class="input-group"> <label for="agenda">Alunos Salvos:</label> <select id="agenda" size="4"> <option>-- Agenda Vazia --</option> </select> </div>
        <div class="button-group" style="margin-top:-5px; margin-bottom: 20px;">
            <button class="edit-contact" onclick="entrarModoEdicao()">Editar Aluno</button>
            <button class="danger" onclick="deletarContato()">Deletar Aluno</button>
        </div>
        
        <h2>Informações do Contato</h2>
        <div class="input-group"> <label>Celular:</label> <input type="text" id="celular" value="5511" oninput="this.value=this.value.replace(/\D/g,'')"> </div>
        <div class="input-group"> <label>Nome do Aluno(a):</label> <input type="text" id="aluno"> </div>
        <div class="input-group"> <label>Série/Turma:</label> <input type="text" id="serie"> </div>
        <div class="button-group">
            <button id="btnSalvarNovo" class="save-contact" onclick="salvarContato()">Salvar Novo Contato</button>
            <button id="btnSalvarEdicao" class="edit-contact hidden" onclick="salvarEdicao()">Salvar Alterações</button>
        </div>
        
        <h2>Mensagem</h2>
        <div class="input-group">
            <label>Texto da Mensagem:</label>
            <textarea id="mensagem" placeholder="Digite sua mensagem aqui..."></textarea>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button class="ai-button" onclick="corrigirTextoComIA()">Corrigir Texto com IA</button>
                <div id="corrigindoStatus"></div>
            </div>
        </div>
        <div class="button-group">
            <button class="primary" onclick="executarEnvio()">Gerar e Abrir WhatsApp</button>
            <button class="tertiary" onclick="limparTudo()">Limpar Campos</button>
        </div>
        
        <h2>Últimos Envios</h2>
        <div id="historicoContainer"></div>
        <div id="statusBar"></div>
    </div>

    <script>
        // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---

        // ######################################################################
        // ### PASSO ÚNICO: COLE A SUA CHAVE DA API DO GOOGLE AI STUDIO AQUI ###
        // ######################################################################
        const SUA_CHAVE_API_AQUI = "AIzaSyB_8nHLA03AodaxHYxZJgpEVLPo5s1EiJc";
        // Exemplo: const SUA_CHAVE_API_AQUI = "AIzaSyB_8nHLA03AodaxHYxZJgpEVLPo5s1EiJc";
        // ######################################################################


        let todosOsContatos = [];
        let contatoOriginalParaEditar = null;

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', function() {
            carregarAgenda();
            carregarHistorico();
            document.getElementById('filtroAgenda').addEventListener('keyup', renderizarAgenda);
            document.getElementById('agenda').addEventListener('change', carregarContato);
        });

        // --- FUNÇÕES DA INTERFACE E STATUS ---
        function mostrarStatus(mensagem, tipo) {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = mensagem;
            statusBar.className = tipo;
            statusBar.classList.add('visible');
            setTimeout(() => statusBar.classList.remove('visible'), 4000);
        }

        // --- FUNÇÕES DA AGENDA (USANDO localStorage) ---
        function carregarAgenda() {
            const agendaSalva = localStorage.getItem('agenda_alunos');
            todosOsContatos = agendaSalva ? JSON.parse(agendaSalva) : [];
            renderizarAgenda();
        }

        function renderizarAgenda() {
            const filtro = document.getElementById('filtroAgenda').value.toLowerCase();
            const selectAgenda = document.getElementById('agenda');
            selectAgenda.innerHTML = '';
            
            const contatosFiltrados = todosOsContatos.filter(c => 
                c.nome.toLowerCase().includes(filtro) || c.serie.toLowerCase().includes(filtro)
            );

            if (contatosFiltrados.length === 0) {
                selectAgenda.innerHTML = '<option value="">-- Nenhum resultado --</option>';
                return;
            }

            contatosFiltrados.forEach(contato => {
                const option = document.createElement('option');
                option.value = JSON.stringify(contato);
                option.textContent = `${contato.nome} (${contato.serie})`;
                selectAgenda.appendChild(option);
            });
        }

        function salvarAgendaNoLocalStorage() {
            localStorage.setItem('agenda_alunos', JSON.stringify(todosOsContatos));
        }

        function salvarContato() {
            const nome = document.getElementById('aluno').value.trim();
            const serie = document.getElementById('serie').value.trim();
            const celular = document.getElementById('celular').value.trim();
            if (!nome || !serie || !celular) {
                mostrarStatus("Preencha Nome, Série e Celular para salvar.", "error");
                return;
            }
            if (todosOsContatos.some(c => c.celular === celular)) {
                mostrarStatus("Este número de celular já existe na agenda.", "error");
                return;
            }
            todosOsContatos.push({ nome, serie, celular });
            salvarAgendaNoLocalStorage();
            mostrarStatus(`Aluno '${nome}' salvo com sucesso!`, "success");
            carregarAgenda();
            limparTudo();
        }
        
        function carregarContato() {
            const selectAgenda = document.getElementById('agenda');
            if (!selectAgenda.value) return;
            try {
                const contato = JSON.parse(selectAgenda.value);
                document.getElementById('aluno').value = contato.nome;
                document.getElementById('serie').value = contato.serie;
                document.getElementById('celular').value = contato.celular;
            } catch (e) {}
        }

        function entrarModoEdicao() {
            const selectAgenda = document.getElementById('agenda');
            if (!selectAgenda.value) { mostrarStatus("Selecione um aluno da lista para editar.", "error"); return; }
            try {
                contatoOriginalParaEditar = JSON.parse(selectAgenda.value);
                carregarContato();
                document.getElementById('btnSalvarNovo').classList.add('hidden');
                document.getElementById('btnSalvarEdicao').classList.remove('hidden');
                mostrarStatus("Modo de Edição: Altere os dados e clique em 'Salvar Alterações'.", "success");
            } catch (e) { mostrarStatus("Selecione um aluno válido para editar.", "error"); }
        }

        function salvarEdicao() {
            const nomeEditado = document.getElementById('aluno').value.trim();
            const serieEditada = document.getElementById('serie').value.trim();
            const celularEditado = document.getElementById('celular').value.trim();
            if (!nomeEditado || !serieEditada || !celularEditado) { mostrarStatus("Todos os campos devem estar preenchidos.", "error"); return; }

            const index = todosOsContatos.findIndex(c => c.celular === contatoOriginalParaEditar.celular);

            if (index !== -1) {
                todosOsContatos[index] = { nome: nomeEditado, serie: serieEditada, celular: celularEditado };
                salvarAgendaNoLocalStorage();
                mostrarStatus("Contato atualizado com sucesso!", "success");
            } else {
                mostrarStatus("Erro: Contato original não encontrado.", "error");
            }
            sairModoEdicao();
        }
        
        function sairModoEdicao() {
            contatoOriginalParaEditar = null;
            document.getElementById('btnSalvarNovo').classList.remove('hidden');
            document.getElementById('btnSalvarEdicao').classList.add('hidden');
            limparTudo();
            carregarAgenda();
        }

        function deletarContato() {
            const selectAgenda = document.getElementById('agenda');
            if (!selectAgenda.value) { mostrarStatus("Selecione um aluno da lista para deletar.", "error"); return; }
            try {
                const contatoParaDeletar = JSON.parse(selectAgenda.value);
                if (confirm(`Remover '${contatoParaDeletar.nome}' da agenda?`)) {
                    todosOsContatos = todosOsContatos.filter(c => c.celular !== contatoParaDeletar.celular);
                    salvarAgendaNoLocalStorage();
                    mostrarStatus("Aluno removido com sucesso.", "success");
                    limparTudo();
                    carregarAgenda();
                }
            } catch (e) { mostrarStatus("Selecione um aluno válido para deletar.", "error"); }
        }

        function limparTudo() {
            document.getElementById('celular').value = '5511';
            document.getElementById('aluno').value = '';
            document.getElementById('serie').value = '';
            document.getElementById('mensagem').value = '';
            document.getElementById('agenda').selectedIndex = -1;
            document.getElementById('filtroAgenda').value = '';
            if (contatoOriginalParaEditar) { sairModoEdicao(); }
            renderizarAgenda();
        }
        
        // --- FUNÇÕES DE HISTÓRICO (USANDO localStorage) ---
        function carregarHistorico() {
            const container = document.getElementById('historicoContainer');
            const historicoSalvo = localStorage.getItem('historico_envios');
            const historico = historicoSalvo ? JSON.parse(historicoSalvo) : [];
            container.innerHTML = '';
            
            const ultimosEnvios = historico.slice(-10).reverse();

            ultimosEnvios.forEach(linha => {
                if (linha.trim() === "") return;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'historicoItem';
                itemDiv.textContent = linha;
                const separador = "Mensagem: ";
                const pos = linha.indexOf(separador);
                if (pos !== -1) {
                    const mensagem = linha.substring(pos + separador.length);
                    itemDiv.setAttribute('data-mensagem', mensagem);
                }
                itemDiv.addEventListener('dblclick', () => reusarMensagem(itemDiv));
                container.appendChild(itemDiv);
            });
        }
        
        function reusarMensagem(elemento) {
            const mensagem = elemento.getAttribute('data-mensagem');
            if (mensagem) {
                document.getElementById('mensagem').value = mensagem;
                mostrarStatus("Mensagem copiada do histórico!", "success");
            }
        }

        function salvarHistorico(linha) {
            const historicoSalvo = localStorage.getItem('historico_envios');
            let historico = historicoSalvo ? JSON.parse(historicoSalvo) : [];
            historico.push(linha);
            localStorage.setItem('historico_envios', JSON.stringify(historico));
        }

        // --- FUNÇÃO DE ENVIO E IA ---
        async function corrigirTextoComIA() {
            const textInput = document.getElementById('mensagem');
            const statusDiv = document.getElementById('corrigindoStatus');
            const textoOriginal = textInput.value;

            if (!textoOriginal) {
                mostrarStatus("Digite uma mensagem para corrigir.", "error");
                return;
            }
            if (!SUA_CHAVE_API_AQUI || SUA_CHAVE_API_AQUI === "COLE_A_SUA_CHAVE_AQUI") {
                 mostrarStatus("Chave API não configurada no código-fonte.", "error");
                return;
            }

            statusDiv.textContent = "Corrigindo...";
            
            const prompt = `Corrija a gramática, ortografia e concordância do seguinte texto em português, mantendo o tom original. Retorne apenas o texto corrigido, sem nenhuma outra palavra, explicação ou formatação:\n\n"${textoOriginal}"`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${SUA_CHAVE_API_AQUI}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Erro da API:", errorData);
                    throw new Error(`Erro na API: ${errorData.error.message}`);
                }

                const data = await response.json();
                const textoCorrigido = data.candidates[0].content.parts[0].text.trim();
                textInput.value = textoCorrigido;
                mostrarStatus("Texto corrigido pela IA!", "success");

            } catch (error) {
                console.error("Erro ao chamar a API:", error);
                mostrarStatus("Erro ao conectar com a IA. Verifique a chave ou a conexão.", "error");
            } finally {
                statusDiv.textContent = "";
            }
        }

        function executarEnvio() {
            const aluno = document.getElementById('aluno').value.trim();
            const celular = document.getElementById('celular').value.trim();
            const mensagem = document.getElementById('mensagem').value.trim();
            const serie = document.getElementById('serie').value.trim();
            if (!aluno || !serie || !celular || celular.length < 12 || !mensagem) {
                mostrarStatus("Preencha todos os campos antes de gerar o link.", "error");
                return;
            }

            const agora = new Date();
            const timestampSeguro = `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}-${String(agora.getDate()).padStart(2, '0')} ${String(agora.getHours()).padStart(2, '0')}:${String(agora.getMinutes()).padStart(2, '0')}`;
            const mensagemParaSalvar = mensagem.replace(/\n/g, " ");
            const linhaHistorico = `${timestampSeguro} - Para: ${aluno} - ${serie} (${celular}) Mensagem: ${mensagemParaSalva_r}`;
            
            salvarHistorico(linhaHistorico);
            carregarHistorico();
            gerarLink();
        }

        function gerarLink() {
            const celular = document.getElementById('celular').value;
            const mensagem = document.getElementById('mensagem').value;
            const aluno = document.getElementById('aluno').value;
            const serie = document.getElementById('serie').value;
            
            const nomeEscola = "E.E. Prof. Neiva de Lourdes Andrade";
            const mensagemFinal = `${nomeEscola}\n\n${aluno} - ${serie}\n\n${mensagem}`;

            const textoCodificado = encodeURIComponent(mensagemFinal);
            const urlWhatsApp = `https://wa.me/${celular}?text=${textoCodificado}`;
            
            window.open(urlWhatsApp, '_blank');
            limparTudo();
        }
    </script>
</body>
</html>